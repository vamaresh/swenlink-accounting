<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Limited Companies - Accounting System (Premium)</title>
    
    <!-- Clerk Authentication -->
    <script 
        async 
        crossorigin="anonymous" 
        data-clerk-publishable-key="pk_test_b3Blbi1yaGluby0zMS5jbGVyay5hY2NvdW50cy5kZXYk"
        src="https://open-rhino-31.clerk.accounts.dev/npm/@clerk/clerk-js@latest/dist/clerk.browser.js">
    </script>
    
    <!-- Supabase Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- React -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .modal-backdrop { backdrop-filter: blur(4px); }
        .sidebar { transition: transform 0.3s ease; }
        @media print { .no-print { display: none; } }
        .sidebar-item { transition: all 0.2s; }
        .sidebar-item:hover { background-color: rgba(59, 130, 246, 0.2); }
        .sidebar-item.active { background-color: rgba(59, 130, 246, 0.3); border-left: 4px solid #3b82f6; }
        @media (max-width: 768px) {
            .sidebar { position: fixed; height: 100vh; z-index: 50; }
            .sidebar.closed { transform: translateX(-100%); }
        }
        .image-preview { max-width: 100%; max-height: 200px; object-fit: contain; border-radius: 8px; margin-top: 8px; }
        .image-thumbnail { width: 80px; height: 80px; object-fit: cover; border-radius: 4px; cursor: pointer; }
        * { -webkit-tap-highlight-color: transparent; }
        input, textarea, select, button { font-size: 16px; } /* Prevents zoom on iOS */
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        // React Components and App Code
        const { useState, useEffect, useMemo } = React;

        // Icon Component (simplified SVG icons)
        const Icon = ({ name, className = "w-6 h-6" }) => {
            const paths = {
                Building2: "M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4",
                Users: "M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z",
                FileText: "M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z",
                Receipt: "M9 14l6-6m-5.5.5h.01m4.99 5h.01M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16l3.5-2 3.5 2 3.5-2 3.5 2z",
                DollarSign: "M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z",
                Plus: "M12 4v16m8-8H4",
                Search: "M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z",
                Download: "M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4",
                Upload: "M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12",
                X: "M6 18L18 6M6 6l12 12",
                Edit2: "M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z",
                Trash2: "M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16",
                Home: "M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6",
                LogOut: "M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1",
                Send: "M12 19l9 2-9-18-9 18 9-2zm0 0v-8",
                Lock: "M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z",
                CheckCircle: "M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z",
                Clock: "M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z",
                ArrowUpRight: "M7 17L17 7M17 7H7M17 7v10",
                ArrowDownRight: "M7 7l10 10M17 17H7M17 17V7",
                PiggyBank: "M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z",
                CreditCard: "M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z",
                TrendingUp: "M13 7h8m0 0v8m0-8l-8 8-4-4-6 6",
                BarChart3: "M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z",
                Save: "M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4",
                FileCheck: "M9 12l2 2 4-4M7.835 4.697a3.42 3.42 0 001.946-.806 3.42 3.42 0 014.438 0 3.42 3.42 0 001.946.806 3.42 3.42 0 013.138 3.138 3.42 3.42 0 00.806 1.946 3.42 3.42 0 010 4.438 3.42 3.42 0 00-.806 1.946 3.42 3.42 0 01-3.138 3.138 3.42 3.42 0 00-1.946.806 3.42 3.42 0 01-4.438 0 3.42 3.42 0 00-1.946-.806 3.42 3.42 0 01-3.138-3.138 3.42 3.42 0 00-.806-1.946 3.42 3.42 0 010-4.438 3.42 3.42 0 00.806-1.946 3.42 3.42 0 013.138-3.138z",
                Camera: "M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z M15 13a3 3 0 11-6 0 3 3 0 016 0z",
                Image: "M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z",
                Menu: "M4 6h16M4 12h16M4 18h16"
            };
            return (
                <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d={paths[name] || paths.Home} />
                </svg>
            );
        };

        // Initialize Clerk
        const CLERK_PUBLISHABLE_KEY = 'pk_test_b3Blbi1yaGluby0zMS5jbGVyay5hY2NvdW50cy5kZXYk';
        const ADMIN_EMAIL = 'amareshvel@gmail.com';
        
        // Initialize Supabase
        const SUPABASE_URL = 'https://brorfoqjqzkkwetbykly.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJyb3Jmb3FqcXpra3dldGJ5a2x5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU3MzYyNzgsImV4cCI6MjA4MTMxMjI3OH0.eBBAQpyzt-umBMTYkjVgUg3uXo4sPe4nLfw9eEhqS2c';
        
        const { createClient } = supabase;
        let supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        const SwenlinkAccounting = () => {
            const [clerk, setClerk] = useState(null);
            const [user, setUser] = useState(null);
            const [subscription, setSubscription] = useState(null);
            const [isLoading, setIsLoading] = useState(true);
            const [showCompanySetup, setShowCompanySetup] = useState(false);
            const [companyForm, setCompanyForm] = useState({
                name: '', regNumber: '', taxNumber: '', 
                address: '', financialYearStart: '2025-01-01'
            });
            const [activeTab, setActiveTab] = useState('dashboard');
            const [showModal, setShowModal] = useState(false);
            const [modalType, setModalType] = useState('');
            const [formData, setFormData] = useState({});
            const [editingId, setEditingId] = useState(null);
            const [searchTerm, setSearchTerm] = useState('');
            const [sidebarOpen, setSidebarOpen] = useState(true);
            
            const [data, setData] = useState({
                company: {},
                customers: [],
                suppliers: [],
                invoices: [],
                bills: [],
                expenses: [],
                bankAccounts: [],
                bankTransactions: [],
                chartOfAccounts: [
                    { id: 1, code: '1000', name: 'Cash', type: 'Asset', balance: 25000 },
                    { id: 2, code: '1200', name: 'Accounts Receivable', type: 'Asset', balance: 0 },
                    { id: 3, code: '2000', name: 'Accounts Payable', type: 'Liability', balance: 0 },
                    { id: 4, code: '2100', name: 'VAT Payable', type: 'Liability', balance: 0 },
                    { id: 5, code: '3000', name: 'Capital', type: 'Equity', balance: 25000 },
                    { id: 6, code: '4000', name: 'Sales Revenue', type: 'Income', balance: 0 },
                    { id: 7, code: '5000', name: 'Operating Expenses', type: 'Expense', balance: 0 }
                ],
                vatReturns: []
            });

            useEffect(() => {
                initializeClerk();
            }, []);

            async function initializeClerk() {
                try {
                    // Wait for Clerk to load (it auto-initializes with data-clerk-publishable-key)
                    const waitForClerk = () => {
                        return new Promise((resolve) => {
                            if (window.Clerk) {
                                resolve(window.Clerk);
                            } else {
                                const checkClerk = setInterval(() => {
                                    if (window.Clerk) {
                                        clearInterval(checkClerk);
                                        resolve(window.Clerk);
                                    }
                                }, 100);
                            }
                        });
                    };

                    const clerkInstance = await waitForClerk();
                    setClerk(clerkInstance);

                    if (clerkInstance.user) {
                        await handleUserSignedIn(clerkInstance.user);
                    } else {
                        setIsLoading(false);
                    }

                    // Listen for auth changes
                    clerkInstance.addListener((event) => {
                        if (event.user) {
                            handleUserSignedIn(event.user);
                        } else {
                            setUser(null);
                            setSubscription(null);
                        }
                    });
                } catch (error) {
                    console.error('Failed to initialize Clerk:', error);
                    setIsLoading(false);
                }
            }

            async function handleUserSignedIn(clerkUser) {
                setUser(clerkUser);
                
                // Get Clerk session token for Supabase RLS
                const token = await clerkUser.getToken();
                
                // Reinitialize Supabase with Clerk token
                supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
                    global: {
                        headers: {
                            Authorization: `Bearer ${token}`
                        }
                    }
                });

                // Check/create subscription record
                await ensureSubscription(clerkUser);
                
                // Load company and data
                await loadCompanyAndData();
                
                setIsLoading(false);
            }

            async function ensureSubscription(clerkUser) {
                try {
                    const email = clerkUser.primaryEmailAddress?.emailAddress;
                    if (!email) return;

                    // Check if subscription exists
                    const { data: existing, error: fetchError } = await supabaseClient
                        .from('user_subscriptions')
                        .select('*')
                        .eq('clerk_user_id', clerkUser.id)
                        .single();

                    if (fetchError && fetchError.code !== 'PGRST116') {
                        console.error('Error fetching subscription:', fetchError);
                        return;
                    }

                    if (existing) {
                        setSubscription(existing);
                    } else {
                        // Create new subscription
                        const isAdmin = email === ADMIN_EMAIL;
                        const { data: newSub, error: createError } = await supabaseClient
                            .from('user_subscriptions')
                            .insert({
                                clerk_user_id: clerkUser.id,
                                email: email,
                                subscription_tier: isAdmin ? 'admin' : 'free',
                                subscription_status: 'active'
                            })
                            .select()
                            .single();

                        if (createError) {
                            console.error('Error creating subscription:', createError);
                        } else {
                            setSubscription(newSub);
                        }
                    }
                } catch (error) {
                    console.error('Error ensuring subscription:', error);
                }
            }

            async function loadCompanyAndData() {
                try {
                    // Load company
                    const { data: company, error: companyError } = await supabaseClient
                        .from('companies')
                        .select('*')
                        .single();

                    if (companyError) {
                        if (companyError.code === 'PGRST116') {
                            // No company found, show setup
                            setShowCompanySetup(true);
                        } else {
                            console.error('Error loading company:', companyError);
                        }
                        setData(prev => ({ ...prev, company: {} }));
                    } else {
                        setData(prev => ({
                            ...prev,
                            company: {
                                name: company.name,
                                regNumber: company.reg_number,
                                taxNumber: company.tax_number,
                                address: company.address,
                                financialYearStart: company.financial_year_start,
                                mtdEnabled: true
                            }
                        }));
                    }

                    // Load all data in parallel
                    const [
                        customersRes,
                        suppliersRes,
                        invoicesRes,
                        billsRes,
                        expensesRes,
                        bankAccountsRes,
                        bankTransactionsRes,
                        chartRes,
                        vatReturnsRes
                    ] = await Promise.all([
                        supabaseClient.from('customers').select('*'),
                        supabaseClient.from('suppliers').select('*'),
                        supabaseClient.from('invoices').select('*'),
                        supabaseClient.from('bills').select('*'),
                        supabaseClient.from('expenses').select('*'),
                        supabaseClient.from('bank_accounts').select('*'),
                        supabaseClient.from('bank_transactions').select('*'),
                        supabaseClient.from('chart_of_accounts').select('*'),
                        supabaseClient.from('vat_returns').select('*')
                    ]);

                    setData(prev => ({
                        ...prev,
                        customers: customersRes.data || [],
                        suppliers: suppliersRes.data || [],
                        invoices: invoicesRes.data || [],
                        bills: billsRes.data || [],
                        expenses: expensesRes.data || [],
                        bankAccounts: bankAccountsRes.data || [],
                        bankTransactions: bankTransactionsRes.data || [],
                        chartOfAccounts: chartRes.data || [],
                        vatReturns: vatReturnsRes.data || []
                    }));
                } catch (error) {
                    console.error('Error loading data:', error);
                }
            }

            async function handleCompanySetup(e) {
                e.preventDefault();
                try {
                    const { error } = await supabaseClient
                        .from('companies')
                        .insert({
                            clerk_user_id: user.id,
                            name: companyForm.name,
                            reg_number: companyForm.regNumber,
                            tax_number: companyForm.taxNumber,
                            address: companyForm.address,
                            financial_year_start: companyForm.financialYearStart
                        });

                    if (error) {
                        console.error('Error creating company:', error);
                        alert('Failed to create company. Please try again.');
                        return;
                    }

                    // Initialize default chart of accounts
                    const defaultAccounts = [
                        { code: '1000', name: 'Cash', type: 'Asset', balance: 0 },
                        { code: '1200', name: 'Accounts Receivable', type: 'Asset', balance: 0 },
                        { code: '2000', name: 'Accounts Payable', type: 'Liability', balance: 0 },
                        { code: '2100', name: 'VAT Payable', type: 'Liability', balance: 0 },
                        { code: '3000', name: 'Capital', type: 'Equity', balance: 0 },
                        { code: '4000', name: 'Sales Revenue', type: 'Income', balance: 0 },
                        { code: '5000', name: 'Operating Expenses', type: 'Expense', balance: 0 }
                    ];

                    const accountsToInsert = defaultAccounts.map(acc => ({
                        clerk_user_id: user.id,
                        ...acc
                    }));

                    await supabaseClient.from('chart_of_accounts').insert(accountsToInsert);

                    setShowCompanySetup(false);
                    await loadCompanyAndData();
                } catch (error) {
                    console.error('Error setting up company:', error);
                    alert('Failed to setup company. Please try again.');
                }
            }

            const handleLogout = async () => {
                if (clerk) {
                    await clerk.signOut();
                }
                setUser(null);
                setSubscription(null);
                setActiveTab('dashboard');
            };

            // CRUD Operations and Image Upload
            const handleImageUpload = async (e) => {
                const file = e.target.files[0];
                if (!file || !file.type.startsWith('image/')) return;

                try {
                    const fileName = `${user.id}/${Date.now()}-${file.name}`;
                    const { data, error } = await supabaseClient.storage
                        .from('bill-images')
                        .upload(fileName, file);

                    if (error) {
                        console.error('Error uploading image:', error);
                        alert('Failed to upload image');
                        return;
                    }

                    const { data: { publicUrl } } = supabaseClient.storage
                        .from('bill-images')
                        .getPublicUrl(fileName);

                    const images = formData.images || [];
                    setFormData({...formData, images: [...images, publicUrl]});
                } catch (error) {
                    console.error('Error uploading image:', error);
                    alert('Failed to upload image');
                }
            };

            const removeImage = (index) => {
                const images = [...(formData.images || [])];
                images.splice(index, 1);
                setFormData({...formData, images});
            };

            const openModal = (type, item = null) => {
                setModalType(type);
                setEditingId(item?.id || null);
                const defaultData = item || {};
                if ((type === 'invoice' || type === 'bill') && !item) {
                    defaultData.vatRate = 0.20;
                }
                setFormData(defaultData);
                setShowModal(true);
            };

            const closeModal = () => {
                setShowModal(false);
                setModalType('');
                setFormData({});
                setEditingId(null);
            };

            const handleSubmit = async (e) => {
                e.preventDefault();
                
                try {
                    switch(modalType) {
                        case 'customer':
                            if (editingId) {
                                await supabaseClient.from('customers').update({
                                    name: formData.name, email: formData.email,
                                    phone: formData.phone, address: formData.address
                                }).eq('id', editingId);
                            } else {
                                await supabaseClient.from('customers').insert({
                                    clerk_user_id: user.id, name: formData.name,
                                    email: formData.email, phone: formData.phone,
                                    address: formData.address
                                });
                            }
                            break;
                        case 'supplier':
                            if (editingId) {
                                await supabaseClient.from('suppliers').update({
                                    name: formData.name, email: formData.email,
                                    phone: formData.phone, address: formData.address
                                }).eq('id', editingId);
                            } else {
                                await supabaseClient.from('suppliers').insert({
                                    clerk_user_id: user.id, name: formData.name,
                                    email: formData.email, phone: formData.phone,
                                    address: formData.address
                                });
                            }
                            break;
                        case 'invoice':
                            const iSub = parseFloat(formData.subtotal || 0);
                            const iRate = parseFloat(formData.vatRate || 0.20);
                            const iVAT = parseFloat(formData.vat || (iSub * iRate));
                            if (editingId) {
                                await supabaseClient.from('invoices').update({
                                    customer_id: formData.customerId, invoice_number: formData.invoiceNumber,
                                    date: formData.date, due_date: formData.dueDate,
                                    description: formData.description, subtotal: iSub,
                                    vat_rate: iRate, vat: iVAT, total: iSub + iVAT,
                                    status: formData.status || 'unpaid'
                                }).eq('id', editingId);
                            } else {
                                await supabaseClient.from('invoices').insert({
                                    clerk_user_id: user.id, customer_id: formData.customerId,
                                    invoice_number: formData.invoiceNumber,
                                    date: formData.date || new Date().toISOString().split('T')[0],
                                    due_date: formData.dueDate, description: formData.description,
                                    subtotal: iSub, vat_rate: iRate, vat: iVAT,
                                    total: iSub + iVAT, status: formData.status || 'unpaid'
                                });
                            }
                            break;
                        case 'bill':
                            const bSub = parseFloat(formData.subtotal || 0);
                            const bRate = parseFloat(formData.vatRate || 0.20);
                            const bVAT = parseFloat(formData.vat || (bSub * bRate));
                            if (editingId) {
                                await supabaseClient.from('bills').update({
                                    supplier_id: formData.supplierId, bill_number: formData.billNumber,
                                    date: formData.date, due_date: formData.dueDate,
                                    description: formData.description, subtotal: bSub,
                                    vat_rate: bRate, vat: bVAT, total: bSub + bVAT,
                                    status: formData.status || 'unpaid'
                                }).eq('id', editingId);
                                if (formData.images?.length > 0) {
                                    await supabaseClient.from('bill_images').delete().eq('bill_id', editingId);
                                    await supabaseClient.from('bill_images').insert(
                                        formData.images.map(url => ({ bill_id: editingId, image_url: url }))
                                    );
                                }
                            } else {
                                const { data: newBill } = await supabaseClient.from('bills').insert({
                                    clerk_user_id: user.id, supplier_id: formData.supplierId,
                                    bill_number: formData.billNumber,
                                    date: formData.date || new Date().toISOString().split('T')[0],
                                    due_date: formData.dueDate, description: formData.description,
                                    subtotal: bSub, vat_rate: bRate, vat: bVAT,
                                    total: bSub + bVAT, status: formData.status || 'unpaid'
                                }).select().single();
                                if (formData.images?.length > 0 && newBill) {
                                    await supabaseClient.from('bill_images').insert(
                                        formData.images.map(url => ({ bill_id: newBill.id, image_url: url }))
                                    );
                                }
                            }
                            break;
                        case 'expense':
                            if (editingId) {
                                await supabaseClient.from('expenses').update({
                                    date: formData.date, category: formData.category,
                                    description: formData.description, amount: parseFloat(formData.amount || 0),
                                    payment_method: formData.paymentMethod
                                }).eq('id', editingId);
                                if (formData.images?.length > 0) {
                                    await supabaseClient.from('expense_images').delete().eq('expense_id', editingId);
                                    await supabaseClient.from('expense_images').insert(
                                        formData.images.map(url => ({ expense_id: editingId, image_url: url }))
                                    );
                                }
                            } else {
                                const { data: newExp } = await supabaseClient.from('expenses').insert({
                                    clerk_user_id: user.id,
                                    date: formData.date || new Date().toISOString().split('T')[0],
                                    category: formData.category, description: formData.description,
                                    amount: parseFloat(formData.amount || 0),
                                    payment_method: formData.paymentMethod
                                }).select().single();
                                if (formData.images?.length > 0 && newExp) {
                                    await supabaseClient.from('expense_images').insert(
                                        formData.images.map(url => ({ expense_id: newExp.id, image_url: url }))
                                    );
                                }
                            }
                            break;
                        case 'account':
                            if (editingId) {
                                await supabaseClient.from('chart_of_accounts').update({
                                    code: formData.code, name: formData.name,
                                    type: formData.type, balance: parseFloat(formData.balance || 0)
                                }).eq('id', editingId);
                            } else {
                                await supabaseClient.from('chart_of_accounts').insert({
                                    clerk_user_id: user.id, code: formData.code,
                                    name: formData.name, type: formData.type,
                                    balance: parseFloat(formData.balance || 0)
                                });
                            }
                            break;
                        case 'bankAccount':
                            if (editingId) {
                                await supabaseClient.from('bank_accounts').update({
                                    name: formData.name, bank: formData.bank,
                                    account_number: formData.accountNumber, sort_code: formData.sortCode,
                                    balance: parseFloat(formData.balance || 0),
                                    currency: formData.currency || 'GBP'
                                }).eq('id', editingId);
                            } else {
                                await supabaseClient.from('bank_accounts').insert({
                                    clerk_user_id: user.id, name: formData.name, bank: formData.bank,
                                    account_number: formData.accountNumber, sort_code: formData.sortCode,
                                    balance: parseFloat(formData.balance || 0),
                                    currency: formData.currency || 'GBP'
                                });
                            }
                            break;
                    }
                    
                    await loadCompanyAndData();
                    closeModal();
                } catch (error) {
                    console.error('Error saving:', error);
                    alert('Failed to save. Please try again.');
                }
            };

            const handleDelete = async (type, id) => {
                if (!confirm('Are you sure you want to delete this item?')) return;
                
                try {
                    const tableMap = {
                        'customer': 'customers', 'supplier': 'suppliers',
                        'invoice': 'invoices', 'bill': 'bills', 'expense': 'expenses',
                        'account': 'chart_of_accounts', 'vat': 'vat_returns',
                        'bankAccount': 'bank_accounts'
                    };
                    
                    await supabaseClient.from(tableMap[type]).delete().eq('id', id);
                    await loadCompanyAndData();
                } catch (error) {
                    console.error('Error deleting:', error);
                    alert('Failed to delete. Please try again.');
                }
            };

            const generateVATReturn = async () => {
                try {
                    const today = new Date();
                    const quarterStart = new Date(today.getFullYear(), Math.floor(today.getMonth() / 3) * 3, 1);
                    const quarterEnd = new Date(today.getFullYear(), Math.floor(today.getMonth() / 3) * 3 + 3, 0);
                    const startStr = quarterStart.toISOString().split('T')[0];
                    const endStr = quarterEnd.toISOString().split('T')[0];
                    
                    const relevantInvoices = data.invoices.filter(inv => inv.date >= startStr && inv.date <= endStr);
                    const relevantBills = data.bills.filter(bill => bill.date >= startStr && bill.date <= endStr);
                    
                    const outputVAT = relevantInvoices.reduce((sum, inv) => sum + (parseFloat(inv.vat) || 0), 0);
                    const inputVAT = relevantBills.reduce((sum, bill) => sum + (parseFloat(bill.vat) || 0), 0);
                    const vatDue = outputVAT - inputVAT;
                    
                    await supabaseClient.from('vat_returns').insert({
                        clerk_user_id: user.id,
                        period_start: startStr, period_end: endStr,
                        output_vat: outputVAT, input_vat: inputVAT, vat_due: vatDue,
                        status: 'draft', generated_date: new Date().toISOString().split('T')[0]
                    });
                    
                    await loadCompanyAndData();
                    alert(`VAT Return Generated!\nOutput VAT: £${outputVAT.toFixed(2)}\nInput VAT: £${inputVAT.toFixed(2)}\nVAT Due: £${vatDue.toFixed(2)}\n\nStatus: Draft - Review and file when ready`);
                } catch (error) {
                    console.error('Error generating VAT return:', error);
                    alert('Failed to generate VAT return.');
                }
            };

            const fileVATReturn = async (id) => {
                if (!confirm('Are you sure you want to file this VAT return? This action marks it as filed.')) return;
                try {
                    await supabaseClient.from('vat_returns').update({
                        status: 'filed',
                        filed_date: new Date().toISOString().split('T')[0]
                    }).eq('id', id);
                    await loadCompanyAndData();
                    alert('VAT Return filed successfully!');
                } catch (error) {
                    console.error('Error filing VAT return:', error);
                    alert('Failed to file VAT return.');
                }
            };

            const exportInvoicePDF = (invoice) => {
                const customer = data.customers.find(c => c.id == invoice.customerId);
                const printWindow = window.open('', '_blank');
                const vatPercent = ((invoice.vatRate || 0.20) * 100).toFixed(0);
                
                printWindow.document.write(`
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <title>Invoice ${invoice.invoiceNumber}</title>
                        <style>
                            body { font-family: Arial, sans-serif; padding: 40px; max-width: 800px; margin: 0 auto; }
                            .header { display: flex; justify-content: space-between; margin-bottom: 40px; border-bottom: 3px solid #2563eb; padding-bottom: 20px; }
                            .company { font-size: 24px; font-weight: bold; color: #2563eb; }
                            .company-details { font-size: 12px; color: #666; margin-top: 5px; }
                            .invoice-title { font-size: 32px; font-weight: bold; color: #333; }
                            .invoice-number { font-size: 14px; color: #666; }
                            .details-section { display: flex; justify-content: space-between; margin-bottom: 30px; }
                            .details-box { width: 48%; }
                            .details-box h3 { margin: 0 0 10px 0; color: #2563eb; font-size: 14px; }
                            .details-box p { margin: 5px 0; font-size: 13px; color: #333; }
                            table { width: 100%; border-collapse: collapse; margin: 20px 0; }
                            th { background: #f3f4f6; padding: 12px; text-align: left; font-size: 13px; border-bottom: 2px solid #ddd; }
                            td { padding: 12px; border-bottom: 1px solid #eee; font-size: 13px; }
                            .total-section { margin-top: 20px; float: right; width: 300px; }
                            .total-row { display: flex; justify-content: space-between; padding: 8px 0; font-size: 14px; }
                            .total-row.final { border-top: 2px solid #333; font-weight: bold; font-size: 18px; color: #2563eb; margin-top: 10px; padding-top: 10px; }
                            .footer { margin-top: 80px; text-align: center; font-size: 11px; color: #999; border-top: 1px solid #eee; padding-top: 20px; }
                            @media print { body { padding: 20px; } }
                        </style>
                    </head>
                    <body>
                        <div class="header">
                            <div>
                                <div class="company">${data.company.name}</div>
                                <div class="company-details">
                                    ${data.company.regNumber ? `Reg No: ${data.company.regNumber}<br>` : ''}
                                    ${data.company.taxNumber ? `Tax No: ${data.company.taxNumber}<br>` : ''}
                                    ${data.company.address ? data.company.address : ''}
                                </div>
                            </div>
                            <div style="text-align: right;">
                                <div class="invoice-title">INVOICE</div>
                                <div class="invoice-number">#${invoice.invoiceNumber}</div>
                            </div>
                        </div>
                        
                        <div class="details-section">
                            <div class="details-box">
                                <h3>BILL TO:</h3>
                                <p><strong>${customer?.name || 'Unknown Customer'}</strong></p>
                                ${customer?.email ? `<p>${customer.email}</p>` : ''}
                                ${customer?.phone ? `<p>${customer.phone}</p>` : ''}
                                ${customer?.address ? `<p>${customer.address}</p>` : ''}
                            </div>
                            <div class="details-box" style="text-align: right;">
                                <p><strong>Invoice Date:</strong> ${invoice.date}</p>
                                <p><strong>Due Date:</strong> ${invoice.dueDate}</p>
                                <p><strong>Status:</strong> <span style="text-transform: uppercase; color: ${invoice.status === 'paid' ? '#10b981' : invoice.status === 'overdue' ? '#ef4444' : '#f59e0b'};">${invoice.status}</span></p>
                            </div>
                        </div>
                        
                        <table>
                            <thead>
                                <tr>
                                    <th>Description</th>
                                    <th style="text-align: right;">Amount</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>${invoice.description || 'Services Rendered'}</td>
                                    <td style="text-align: right;">£${invoice.subtotal.toFixed(2)}</td>
                                </tr>
                            </tbody>
                        </table>
                        
                        <div class="total-section">
                            <div class="total-row">
                                <span>Subtotal:</span>
                                <span>£${invoice.subtotal.toFixed(2)}</span>
                            </div>
                            <div class="total-row">
                                <span>VAT (${vatPercent}%):</span>
                                <span>£${invoice.vat.toFixed(2)}</span>
                            </div>
                            <div class="total-row final">
                                <span>TOTAL:</span>
                                <span>£${invoice.total.toFixed(2)}</span>
                            </div>
                        </div>
                        
                        <div style="clear: both;"></div>
                        
                        <div style="margin-top: 40px; padding: 20px; background: #f9fafb; border-radius: 8px; border: 1px solid #e5e7eb;">
                            <h3 style="margin: 0 0 15px 0; color: #2563eb; font-size: 16px;">Payment Information</h3>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; font-size: 13px;">
                                ${data.bankAccounts && data.bankAccounts.length > 0 ? `
                                    <div>
                                        <p style="margin: 5px 0; color: #666;"><strong>Bank Name:</strong></p>
                                        <p style="margin: 5px 0; color: #333;">${data.bankAccounts[0].bank || 'N/A'}</p>
                                    </div>
                                    <div>
                                        <p style="margin: 5px 0; color: #666;"><strong>Account Name:</strong></p>
                                        <p style="margin: 5px 0; color: #333;">${data.bankAccounts[0].name || 'N/A'}</p>
                                    </div>
                                    ${data.bankAccounts[0].accountNumber ? `
                                    <div>
                                        <p style="margin: 5px 0; color: #666;"><strong>Account Number:</strong></p>
                                        <p style="margin: 5px 0; color: #333; font-family: monospace;">${data.bankAccounts[0].accountNumber}</p>
                                    </div>
                                    ` : ''}
                                    ${data.bankAccounts[0].sortCode ? `
                                    <div>
                                        <p style="margin: 5px 0; color: #666;"><strong>Sort Code:</strong></p>
                                        <p style="margin: 5px 0; color: #333; font-family: monospace;">${data.bankAccounts[0].sortCode}</p>
                                    </div>
                                    ` : ''}
                                ` : '<p style="color: #999;">No bank account information available</p>'}
                                <div style="grid-column: 1 / -1; margin-top: 10px; padding-top: 15px; border-top: 1px solid #e5e7eb;">
                                    <p style="margin: 5px 0; color: #666;"><strong>Payment Reference:</strong></p>
                                    <p style="margin: 5px 0; color: #2563eb; font-size: 16px; font-weight: bold; font-family: monospace;">${invoice.invoiceNumber}</p>
                                    <p style="margin: 10px 0 0 0; color: #999; font-size: 11px;">Please include this reference number with your payment</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="footer">
                            <p>Thank you for your business!</p>
                            <p>${data.company.name} | ${data.company.regNumber || ''} | ${data.company.taxNumber || ''}</p>
                        </div>
                    </body>
                    </html>
                `);
                
                printWindow.document.close();
                setTimeout(() => {
                    printWindow.print();
                }, 250);
            };

            const emailInvoice = (invoice) => {
                const customer = data.customers.find(c => c.id == invoice.customerId);
                if (!customer || !customer.email) {
                    alert('Customer email not found!');
                    return;
                }
                
                const vatPercent = ((invoice.vatRate || 0.20) * 100).toFixed(0);
                const subject = `Invoice ${invoice.invoiceNumber} from ${data.company.name}`;
                const body = `Dear ${customer.name},\n\nPlease find attached invoice ${invoice.invoiceNumber}.\n\nInvoice Details:\n- Date: ${invoice.date}\n- Due Date: ${invoice.dueDate}\n- Subtotal: £${invoice.subtotal.toFixed(2)}\n- VAT (${vatPercent}%): £${invoice.vat.toFixed(2)}\n- Total: £${invoice.total.toFixed(2)}\n\nDescription: ${invoice.description || 'N/A'}\n\nThank you for your business!\n\nBest regards,\n${data.company.name}\nReg No: ${data.company.regNumber || 'N/A'}\nTax No: ${data.company.taxNumber || 'N/A'}`;
                
                const mailtoLink = `mailto:${customer.email}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
                window.location.href = mailtoLink;
            };

            const importBankCSV = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const csv = event.target.result;
                        const lines = csv.split('\n');
                        const transactions = [];
                        
                        // Skip header row, parse CSV (simple implementation)
                        for (let i = 1; i < lines.length; i++) {
                            const line = lines[i].trim();
                            if (!line) continue;
                            
                            const parts = line.split(',');
                            if (parts.length >= 4) {
                                transactions.push({
                                    id: Date.now() + i,
                                    date: parts[0],
                                    description: parts[1],
                                    amount: parseFloat(parts[2]),
                                    balance: parseFloat(parts[3])
                                });
                            }
                        }
                        
                        const newData = {...data};
                        newData.bankTransactions = [...newData.bankTransactions, ...transactions];
                        saveData(newData);
                        alert(`Imported ${transactions.length} transactions successfully!`);
                    } catch (error) {
                        alert('Error importing CSV file. Please check the format.');
                    }
                };
                reader.readAsText(file);
            };

            const exportData = () => {
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `swenlink-backup-${new Date().toISOString().split('T')[0]}.json`;
                link.click();
                URL.revokeObjectURL(url);
            };

            const importData = (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        try {
                            saveData(JSON.parse(event.target.result));
                            alert('Import successful!');
                        } catch {
                            alert('Error importing file');
                        }
                    };
                    reader.readAsText(file);
                }
            };

            const metrics = {
                totalReceivables: data.invoices.filter(i => i.status !== 'paid').reduce((s, i) => s + i.total, 0),
                totalPayables: data.bills.filter(b => b.status !== 'paid').reduce((s, b) => s + b.total, 0),
                totalRevenue: data.invoices.filter(i => i.status === 'paid').reduce((s, i) => s + i.total, 0),
                totalExpenses: data.expenses.reduce((s, e) => s + e.amount, 0),
                cashBalance: data.bankAccounts.reduce((s, b) => s + b.balance, 0)
            };

            if (isLoading) {
                return (
                    <div className="min-h-screen bg-gradient-to-br from-blue-600 to-blue-800 flex items-center justify-center">
                        <div className="text-white text-2xl">Loading...</div>
                    </div>
                );
            }

            // Mount Clerk Sign In
            useEffect(() => {
                if (clerk && !user) {
                    const signInDiv = document.getElementById('clerk-signin');
                    if (signInDiv) {
                        clerk.mountSignIn(signInDiv);
                    }
                }
            }, [clerk, user]);

            if (!user) {
                return (
                    <div className="min-h-screen bg-gradient-to-br from-blue-600 to-blue-800 flex items-center justify-center p-4">
                        <div className="bg-white rounded-lg shadow-2xl p-8 w-full max-w-md">
                            <div className="text-center mb-8">
                                <div className="flex justify-center mb-4">
                                    <div className="bg-blue-100 p-4 rounded-full">
                                        <Icon name="Building2" className="w-12 h-12 text-blue-600" />
                                    </div>
                                </div>
                                <h1 className="text-3xl font-bold text-gray-800 mb-2">Limited Companies</h1>
                                <p className="text-gray-600">Accounting System (Premium)</p>
                            </div>
                            <div id="clerk-signin" className="clerk-signin-container"></div>
                        </div>
                    </div>
                );
            }

            // Company Setup Screen
            if (showCompanySetup) {
                return (
                    <div className="min-h-screen bg-gradient-to-br from-blue-600 to-blue-800 flex items-center justify-center p-4">
                        <div className="bg-white rounded-lg shadow-2xl p-8 w-full max-w-2xl">
                            <div className="text-center mb-8">
                                <div className="flex justify-center mb-4">
                                    <div className="bg-blue-100 p-4 rounded-full">
                                        <Icon name="Building2" className="w-12 h-12 text-blue-600" />
                                    </div>
                                </div>
                                <h1 className="text-3xl font-bold text-gray-800 mb-2">Welcome!</h1>
                                <p className="text-gray-600">Let's set up your company</p>
                            </div>
                            <form onSubmit={handleCompanySetup} className="space-y-4">
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-2">Company Name *</label>
                                    <input
                                        type="text"
                                        value={companyForm.name}
                                        onChange={(e) => setCompanyForm({...companyForm, name: e.target.value})}
                                        className="w-full px-4 py-3 border rounded-lg"
                                        required
                                    />
                                </div>
                                <div className="grid grid-cols-2 gap-4">
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-2">Reg Number</label>
                                        <input
                                            type="text"
                                            value={companyForm.regNumber}
                                            onChange={(e) => setCompanyForm({...companyForm, regNumber: e.target.value})}
                                            className="w-full px-4 py-3 border rounded-lg"
                                        />
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-2">Tax Number</label>
                                        <input
                                            type="text"
                                            value={companyForm.taxNumber}
                                            onChange={(e) => setCompanyForm({...companyForm, taxNumber: e.target.value})}
                                            className="w-full px-4 py-3 border rounded-lg"
                                        />
                                    </div>
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-2">Address</label>
                                    <textarea
                                        value={companyForm.address}
                                        onChange={(e) => setCompanyForm({...companyForm, address: e.target.value})}
                                        className="w-full px-4 py-3 border rounded-lg"
                                        rows="3"
                                    />
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-2">Financial Year Start *</label>
                                    <input
                                        type="date"
                                        value={companyForm.financialYearStart}
                                        onChange={(e) => setCompanyForm({...companyForm, financialYearStart: e.target.value})}
                                        className="w-full px-4 py-3 border rounded-lg"
                                        required
                                    />
                                </div>
                                <button type="submit" className="w-full bg-blue-600 text-white py-3 rounded-lg hover:bg-blue-700 flex items-center justify-center gap-2">
                                    <Icon name="CheckCircle" className="w-5 h-5" />
                                    Complete Setup
                                </button>
                            </form>
                        </div>
                    </div>
                );
            }

            // Render Modal
            const renderModal = () => {
                if (!showModal) return null;

                const fields = {
                    customer: [
                        {name: 'name', label: 'Customer Name', type: 'text', required: true},
                        {name: 'email', label: 'Email', type: 'email', required: true},
                        {name: 'phone', label: 'Phone', type: 'tel'},
                        {name: 'address', label: 'Address', type: 'textarea'}
                    ],
                    supplier: [
                        {name: 'name', label: 'Supplier Name', type: 'text', required: true},
                        {name: 'email', label: 'Email', type: 'email', required: true},
                        {name: 'phone', label: 'Phone', type: 'tel'},
                        {name: 'address', label: 'Address', type: 'textarea'}
                    ],
                    invoice: [
                        {name: 'customerId', label: 'Customer', type: 'select', options: data.customers, required: true},
                        {name: 'invoiceNumber', label: 'Invoice Number', type: 'text', required: true},
                        {name: 'date', label: 'Date', type: 'date', required: true},
                        {name: 'dueDate', label: 'Due Date', type: 'date', required: true},
                        {name: 'description', label: 'Description', type: 'textarea'},
                        {name: 'subtotal', label: 'Subtotal (£)', type: 'number', required: true, step: '0.01', onChange: (val) => {
                            const vatRate = parseFloat(formData.vatRate || 0.20);
                            const vat = (parseFloat(val) || 0) * vatRate;
                            setFormData({...formData, subtotal: val, vat: vat.toFixed(2)});
                        }},
                        {name: 'vatRate', label: 'VAT Rate (e.g. 0.20 for 20%)', type: 'number', required: true, step: '0.01', defaultValue: 0.20, onChange: (val) => {
                            const vatRate = parseFloat(val) || 0.20;
                            const vat = (parseFloat(formData.subtotal) || 0) * vatRate;
                            setFormData({...formData, vatRate: val, vat: vat.toFixed(2)});
                        }},
                        {name: 'vat', label: 'VAT Amount (£)', type: 'number', required: true, step: '0.01', readOnly: true},
                        {name: 'status', label: 'Status', type: 'select', options: [{id: 'unpaid', name: 'Unpaid'}, {id: 'paid', name: 'Paid'}, {id: 'overdue', name: 'Overdue'}]}
                    ],
                    bill: [
                        {name: 'supplierId', label: 'Supplier', type: 'select', options: data.suppliers, required: true},
                        {name: 'billNumber', label: 'Bill Number', type: 'text', required: true},
                        {name: 'date', label: 'Date', type: 'date', required: true},
                        {name: 'dueDate', label: 'Due Date', type: 'date', required: true},
                        {name: 'description', label: 'Description', type: 'textarea'},
                        {name: 'subtotal', label: 'Subtotal (£)', type: 'number', required: true, step: '0.01', onChange: (val) => {
                            const vatRate = parseFloat(formData.vatRate || 0.20);
                            const vat = (parseFloat(val) || 0) * vatRate;
                            setFormData({...formData, subtotal: val, vat: vat.toFixed(2)});
                        }},
                        {name: 'vatRate', label: 'VAT Rate (e.g. 0.20 for 20%)', type: 'number', required: true, step: '0.01', defaultValue: 0.20, onChange: (val) => {
                            const vatRate = parseFloat(val) || 0.20;
                            const vat = (parseFloat(formData.subtotal) || 0) * vatRate;
                            setFormData({...formData, vatRate: val, vat: vat.toFixed(2)});
                        }},
                        {name: 'vat', label: 'VAT Amount (£)', type: 'number', required: true, step: '0.01', readOnly: true},
                        {name: 'status', label: 'Status', type: 'select', options: [{id: 'unpaid', name: 'Unpaid'}, {id: 'paid', name: 'Paid'}, {id: 'overdue', name: 'Overdue'}]},
                        {name: 'images', label: 'Bill Images', type: 'file-images'}
                    ],
                    expense: [
                        {name: 'date', label: 'Date', type: 'date', required: true},
                        {name: 'category', label: 'Category', type: 'select', options: [
                            {id: 'office', name: 'Office Supplies'}, {id: 'travel', name: 'Travel'},
                            {id: 'utilities', name: 'Utilities'}, {id: 'marketing', name: 'Marketing'},
                            {id: 'other', name: 'Other'}
                        ], required: true},
                        {name: 'description', label: 'Description', type: 'text', required: true},
                        {name: 'amount', label: 'Amount (£)', type: 'number', required: true, step: '0.01'},
                        {name: 'paymentMethod', label: 'Payment Method', type: 'select', options: [
                            {id: 'cash', name: 'Cash'}, {id: 'card', name: 'Card'}, {id: 'bank', name: 'Bank Transfer'}
                        ]},
                        {name: 'images', label: 'Receipt/Bill Images', type: 'file-images'}
                    ],
                    account: [
                        {name: 'code', label: 'Account Code', type: 'text', required: true},
                        {name: 'name', label: 'Account Name', type: 'text', required: true},
                        {name: 'type', label: 'Type', type: 'select', options: [
                            {id: 'Asset', name: 'Asset'}, {id: 'Liability', name: 'Liability'},
                            {id: 'Equity', name: 'Equity'}, {id: 'Income', name: 'Income'},
                            {id: 'Expense', name: 'Expense'}
                        ], required: true},
                        {name: 'balance', label: 'Initial Balance (£)', type: 'number', required: true, step: '0.01'}
                    ],
                    bankAccount: [
                        {name: 'name', label: 'Account Name', type: 'text', required: true},
                        {name: 'bank', label: 'Bank Name', type: 'text', required: true},
                        {name: 'accountNumber', label: 'Account Number', type: 'text'},
                        {name: 'sortCode', label: 'Sort Code', type: 'text'},
                        {name: 'balance', label: 'Current Balance (£)', type: 'number', required: true, step: '0.01'},
                        {name: 'currency', label: 'Currency', type: 'select', options: [
                            {id: 'GBP', name: 'GBP (£)'}, {id: 'USD', name: 'USD ($)'}, {id: 'EUR', name: 'EUR (€)'}
                        ], required: true}
                    ]
                };

                return (
                    <div className="fixed inset-0 bg-black bg-opacity-50 modal-backdrop flex items-center justify-center z-50 p-2 md:p-4">
                        <div className="bg-white rounded-lg shadow-2xl max-w-2xl w-full max-h-[95vh] md:max-h-[90vh] overflow-y-auto">
                            <div className="sticky top-0 bg-white border-b px-4 md:px-6 py-3 md:py-4 flex justify-between items-center">
                                <h2 className="text-xl md:text-2xl font-bold capitalize">{editingId ? 'Edit' : 'Add'} {modalType}</h2>
                                <button onClick={closeModal} className="text-gray-500 hover:text-gray-700">
                                    <Icon name="X" className="w-6 h-6" />
                                </button>
                            </div>
                            <form onSubmit={handleSubmit} className="p-4 md:p-6 space-y-4">
                                {fields[modalType]?.map(field => (
                                    <div key={field.name}>
                                        <label className="block text-sm font-medium text-gray-700 mb-1">
                                            {field.label} {field.required && <span className="text-red-500">*</span>}
                                        </label>
                                        {field.type === 'file-images' ? (
                                            <div>
                                                <label className="flex items-center justify-center gap-2 w-full px-4 py-3 border-2 border-dashed border-gray-300 rounded-lg cursor-pointer hover:border-blue-500 hover:bg-blue-50 transition-colors">
                                                    <Icon name="Camera" className="w-5 h-5 text-gray-500" />
                                                    <span className="text-sm text-gray-600">Upload Image</span>
                                                    <input type="file" accept="image/*" onChange={handleImageUpload} className="hidden" />
                                                </label>
                                                {formData.images && formData.images.length > 0 && (
                                                    <div className="mt-3 grid grid-cols-2 sm:grid-cols-3 gap-2">
                                                        {formData.images.map((img, idx) => (
                                                            <div key={idx} className="relative group">
                                                                <img src={img} alt={`Upload ${idx + 1}`} className="image-thumbnail w-full h-24 object-cover rounded border" />
                                                                <button
                                                                    type="button"
                                                                    onClick={() => removeImage(idx)}
                                                                    className="absolute top-1 right-1 bg-red-500 text-white rounded-full p-1 opacity-0 group-hover:opacity-100 transition-opacity"
                                                                >
                                                                    <Icon name="X" className="w-4 h-4" />
                                                                </button>
                                                            </div>
                                                        ))}
                                                    </div>
                                                )}
                                            </div>
                                        ) : field.type === 'textarea' ? (
                                            <textarea
                                                value={formData[field.name] || ''}
                                                onChange={(e) => setFormData({...formData, [field.name]: e.target.value})}
                                                className="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500"
                                                rows="3"
                                                required={field.required}
                                            />
                                        ) : field.type === 'select' ? (
                                            <select
                                                value={formData[field.name] || ''}
                                                onChange={(e) => setFormData({...formData, [field.name]: e.target.value})}
                                                className="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500"
                                                required={field.required}
                                            >
                                                <option value="">Select {field.label}</option>
                                                {field.options?.map(opt => (
                                                    <option key={opt.id} value={opt.id}>{opt.name}</option>
                                                ))}
                                            </select>
                                        ) : (
                                            <input
                                                type={field.type}
                                                value={formData[field.name] !== undefined ? formData[field.name] : (field.defaultValue !== undefined ? field.defaultValue : '')}
                                                onChange={(e) => {
                                                    if (field.onChange) {
                                                        field.onChange(e.target.value);
                                                    } else {
                                                        setFormData({...formData, [field.name]: e.target.value});
                                                    }
                                                }}
                                                className="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500"
                                                required={field.required}
                                                step={field.step}
                                                readOnly={field.readOnly}
                                            />
                                        )}
                                    </div>
                                ))}
                                <div className="flex gap-3 pt-4">
                                    <button type="submit" className="flex-1 bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700">
                                        {editingId ? 'Update' : 'Create'}
                                    </button>
                                    <button type="button" onClick={closeModal} className="flex-1 bg-gray-300 text-gray-700 py-2 rounded-lg hover:bg-gray-400">
                                        Cancel
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                );
            };

            const menuItems = [
                {id: 'dashboard', icon: 'Home', label: 'Dashboard'},
                {id: 'customers', icon: 'Users', label: 'Customers'},
                {id: 'suppliers', icon: 'Users', label: 'Suppliers'},
                {id: 'invoices', icon: 'FileText', label: 'Sales Invoices'},
                {id: 'bills', icon: 'Receipt', label: 'Purchase Bills'},
                {id: 'expenses', icon: 'CreditCard', label: 'Expenses'},
                {id: 'banking', icon: 'PiggyBank', label: 'Banking'},
                {id: 'accounts', icon: 'BarChart3', label: 'Chart of Accounts'},
                {id: 'vat', icon: 'FileCheck', label: 'VAT Returns'}
            ];

            return (
                <div className="min-h-screen bg-gray-100 flex">
                    {/* Sidebar */}
                    {/* Mobile Menu Toggle */}
                    <button
                        onClick={() => setSidebarOpen(!sidebarOpen)}
                        className="md:hidden fixed top-4 left-4 z-50 bg-blue-600 text-white p-2 rounded-lg shadow-lg no-print"
                    >
                        <Icon name="Menu" className="w-6 h-6" />
                    </button>

                    {/* Mobile Overlay */}
                    {sidebarOpen && (
                        <div
                            onClick={() => setSidebarOpen(false)}
                            className="md:hidden fixed inset-0 bg-black bg-opacity-50 z-30 no-print"
                        />
                    )}

                    <div className={`sidebar bg-black w-64 min-h-screen shadow-lg fixed md:relative z-40 no-print ${sidebarOpen ? '' : '-translate-x-full md:translate-x-0'}`}>
                        <div className="p-6 border-b border-gray-700">
                            <div className="flex items-center gap-3 mb-3">
                                <Icon name="Building2" className="w-8 h-8 text-blue-400" />
                                <div>
                                    <h1 className="text-lg font-bold leading-tight text-white">{data.company.name || 'Company'}</h1>
                                    <p className="text-xs text-gray-400">Accounting System</p>
                                </div>
                            </div>
                            {data.company.regNumber && (
                                <div className="mt-2 pt-2 border-t border-gray-700">
                                    <p className="text-xs text-gray-300"><span className="font-semibold">Reg No:</span> {data.company.regNumber}</p>
                                    {data.company.taxNumber && <p className="text-xs text-gray-300"><span className="font-semibold">Tax No:</span> {data.company.taxNumber}</p>}
                                    {data.company.financialYearStart && <p className="text-xs text-gray-300"><span className="font-semibold">FY Start:</span> {new Date(data.company.financialYearStart).toLocaleDateString()}</p>}
                                </div>
                            )}
                        </div>
                        
                        <nav className="p-4">
                            {menuItems.map(item => (
                                <button
                                    key={item.id}
                                    onClick={() => setActiveTab(item.id)}
                                    className={`sidebar-item w-full flex items-center gap-3 px-4 py-3 rounded-lg mb-2 transition-all ${
                                        activeTab === item.id ? 'active font-semibold text-white' : 'text-gray-300 hover:text-white'
                                    }`}
                                >
                                    <Icon name={item.icon} className="w-5 h-5" />
                                    <span>{item.label}</span>
                                </button>
                            ))}
                        </nav>
                        
                        <div className="absolute bottom-0 w-full p-4 border-t border-gray-700">
                            <div className="mb-3 px-2">
                                <p className="text-xs text-gray-400">Logged in as</p>
                                <p className="text-sm font-semibold truncate text-white">{user?.primaryEmailAddress?.emailAddress}</p>
                            </div>
                            <button onClick={exportData} className="w-full flex items-center justify-center gap-2 bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 text-sm mb-2">
                                <Icon name="Download" className="w-4 h-4" />
                                Export
                            </button>
                            <label className="w-full flex items-center justify-center gap-2 bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 cursor-pointer text-sm mb-2">
                                <Icon name="Upload" className="w-4 h-4" />
                                Import
                                <input type="file" accept=".json" onChange={importData} className="hidden" />
                            </label>
                            <button onClick={handleLogout} className="w-full flex items-center justify-center gap-2 bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 text-sm">
                                <Icon name="LogOut" className="w-4 h-4" />
                                Logout
                            </button>
                        </div>
                    </div>
                    
                    {/* Main Content */}
                    <div className="flex-1 p-4 md:p-8 pt-16 md:pt-8">
                        <div className="max-w-7xl mx-auto">

                        {/* Close sidebar on mobile when clicking main content */}
                        <div onClick={() => window.innerWidth < 768 && setSidebarOpen(false)}>
                        {activeTab === 'dashboard' && (
                            <>
                                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                            <div className="bg-gradient-to-br from-blue-500 to-blue-600 rounded-lg p-6 text-white">
                                <Icon name="DollarSign" className="w-8 h-8 mb-2" />
                                <div className="text-3xl font-bold">£{metrics.totalRevenue.toLocaleString()}</div>
                                <div className="text-blue-100 text-sm">Total Revenue</div>
                            </div>
                            <div className="bg-gradient-to-br from-green-500 to-green-600 rounded-lg p-6 text-white">
                                <Icon name="PiggyBank" className="w-8 h-8 mb-2" />
                                <div className="text-3xl font-bold">£{metrics.cashBalance.toLocaleString()}</div>
                                <div className="text-green-100 text-sm">Cash Balance</div>
                            </div>
                            <div className="bg-gradient-to-br from-orange-500 to-orange-600 rounded-lg p-6 text-white">
                                <Icon name="Clock" className="w-8 h-8 mb-2" />
                                <div className="text-3xl font-bold">£{metrics.totalReceivables.toLocaleString()}</div>
                                <div className="text-orange-100 text-sm">Receivables</div>
                            </div>
                            <div className="bg-gradient-to-br from-red-500 to-red-600 rounded-lg p-6 text-white">
                                <Icon name="CreditCard" className="w-8 h-8 mb-2" />
                                <div className="text-3xl font-bold">£{metrics.totalPayables.toLocaleString()}</div>
                                <div className="text-red-100 text-sm">Payables</div>
                            </div>
                        </div>

                        <div className="bg-gradient-to-r from-purple-500 to-purple-600 rounded-lg p-6 text-white">
                            <div className="flex items-center gap-3">
                                <Icon name="FileCheck" className="w-8 h-8" />
                                <div>
                                    <h3 className="text-xl font-bold">MTD Enabled</h3>
                                    <p className="text-purple-100 text-sm">Making Tax Digital for VAT & Income Tax Ready</p>
                                </div>
                            </div>
                            <div className="grid grid-cols-2 gap-4 mt-4">
                                <div className="bg-white bg-opacity-20 rounded p-3">
                                    <div className="text-2xl font-bold">{data.vatReturns.length}</div>
                                    <div className="text-sm">VAT Returns Filed</div>
                                </div>
                                <div className="bg-white bg-opacity-20 rounded p-3">
                                    <div className="text-2xl font-bold">Compliant</div>
                                    <div className="text-sm">HMRC Status</div>
                                </div>
                            </div>
                        </div>
                            </>
                        )}

                        {activeTab === 'customers' && (
                            <div className="bg-white rounded-lg shadow p-4 md:p-6">
                                <div className="flex flex-wrap justify-between items-center gap-3 mb-6">
                                    <h2 className="text-xl md:text-2xl font-bold">Customers</h2>
                                    <button onClick={() => openModal('customer')} className="flex items-center gap-2 bg-blue-600 text-white px-3 md:px-4 py-2 rounded-lg hover:bg-blue-700 text-sm md:text-base">
                                        <Icon name="Plus" className="w-4 md:w-5 h-4 md:h-5" />
                                        <span className="hidden sm:inline">Add Customer</span>
                                        <span className="sm:hidden">Add</span>
                                    </button>
                                </div>
                                <div className="overflow-x-auto">
                                    <table className="w-full min-w-[500px]">
                                        <thead className="bg-gray-50">
                                            <tr>
                                                <th className="px-2 md:px-4 py-3 text-left text-sm font-semibold">Name</th>
                                                <th className="px-2 md:px-4 py-3 text-left text-sm font-semibold">Email</th>
                                                <th className="px-2 md:px-4 py-3 text-left text-sm font-semibold hidden sm:table-cell">Phone</th>
                                                <th className="px-2 md:px-4 py-3 text-left text-sm font-semibold">Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {data.customers.length === 0 ? (
                                                <tr><td colSpan="4" className="text-center py-8 text-gray-500">No customers yet. Add your first customer!</td></tr>
                                            ) : data.customers.map(customer => (
                                                <tr key={customer.id} className="border-t hover:bg-gray-50">
                                                    <td className="px-2 md:px-4 py-3 text-sm">{customer.name}</td>
                                                    <td className="px-2 md:px-4 py-3 text-sm">{customer.email}</td>
                                                    <td className="px-2 md:px-4 py-3 text-sm hidden sm:table-cell">{customer.phone}</td>
                                                    <td className="px-2 md:px-4 py-3">
                                                        <div className="flex gap-2">
                                                            <button onClick={() => openModal('customer', customer)} className="text-blue-600 hover:text-blue-800">
                                                                <Icon name="Edit2" className="w-4 h-4" />
                                                            </button>
                                                            <button onClick={() => handleDelete('customer', customer.id)} className="text-red-600 hover:text-red-800">
                                                                <Icon name="Trash2" className="w-4 h-4" />
                                                            </button>
                                                        </div>
                                                    </td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        )}

                        {activeTab === 'suppliers' && (
                            <div className="bg-white rounded-lg shadow p-4 md:p-6">
                                <div className="flex flex-wrap justify-between items-center gap-3 mb-6">
                                    <h2 className="text-xl md:text-2xl font-bold">Suppliers</h2>
                                    <button onClick={() => openModal('supplier')} className="flex items-center gap-2 bg-blue-600 text-white px-3 md:px-4 py-2 rounded-lg hover:bg-blue-700 text-sm md:text-base">
                                        <Icon name="Plus" className="w-4 md:w-5 h-4 md:h-5" />
                                        <span className="hidden sm:inline">Add Supplier</span>
                                        <span className="sm:hidden">Add</span>
                                    </button>
                                </div>
                                <div className="overflow-x-auto">
                                    <table className="w-full min-w-[500px]">
                                        <thead className="bg-gray-50">
                                            <tr>
                                                <th className="px-2 md:px-4 py-3 text-left text-sm font-semibold">Name</th>
                                                <th className="px-2 md:px-4 py-3 text-left text-sm font-semibold">Email</th>
                                                <th className="px-2 md:px-4 py-3 text-left text-sm font-semibold hidden sm:table-cell">Phone</th>
                                                <th className="px-2 md:px-4 py-3 text-left text-sm font-semibold">Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {data.suppliers.length === 0 ? (
                                                <tr><td colSpan="4" className="text-center py-8 text-gray-500">No suppliers yet. Add your first supplier!</td></tr>
                                            ) : data.suppliers.map(supplier => (
                                                <tr key={supplier.id} className="border-t hover:bg-gray-50">
                                                    <td className="px-2 md:px-4 py-3 text-sm">{supplier.name}</td>
                                                    <td className="px-2 md:px-4 py-3 text-sm">{supplier.email}</td>
                                                    <td className="px-2 md:px-4 py-3 text-sm hidden sm:table-cell">{supplier.phone}</td>
                                                    <td className="px-2 md:px-4 py-3">
                                                        <div className="flex gap-2">
                                                            <button onClick={() => openModal('supplier', supplier)} className="text-blue-600 hover:text-blue-800">
                                                                <Icon name="Edit2" className="w-4 h-4" />
                                                            </button>
                                                            <button onClick={() => handleDelete('supplier', supplier.id)} className="text-red-600 hover:text-red-800">
                                                                <Icon name="Trash2" className="w-4 h-4" />
                                                            </button>
                                                        </div>
                                                    </td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        )}

                        {activeTab === 'invoices' && (
                            <div className="bg-white rounded-lg shadow p-4 md:p-6">
                                <div className="flex flex-wrap justify-between items-center gap-3 mb-6">
                                    <h2 className="text-xl md:text-2xl font-bold">Sales Invoices</h2>
                                    <button onClick={() => openModal('invoice')} className="flex items-center gap-2 bg-blue-600 text-white px-3 md:px-4 py-2 rounded-lg hover:bg-blue-700 text-sm md:text-base">
                                        <Icon name="Plus" className="w-4 md:w-5 h-4 md:h-5" />
                                        <span className="hidden sm:inline">Create Invoice</span>
                                        <span className="sm:hidden">Create</span>
                                    </button>
                                </div>
                                <div className="overflow-x-auto">
                                    <table className="w-full min-w-[600px]">
                                        <thead className="bg-gray-50">
                                            <tr>
                                                <th className="px-4 py-3 text-left text-sm font-semibold">Invoice #</th>
                                                <th className="px-4 py-3 text-left text-sm font-semibold">Customer</th>
                                                <th className="px-4 py-3 text-left text-sm font-semibold">Date</th>
                                                <th className="px-4 py-3 text-left text-sm font-semibold">Total</th>
                                                <th className="px-4 py-3 text-left text-sm font-semibold">Status</th>
                                                <th className="px-4 py-3 text-left text-sm font-semibold">Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {data.invoices.length === 0 ? (
                                                <tr><td colSpan="6" className="text-center py-8 text-gray-500">No invoices yet. Create your first invoice!</td></tr>
                                            ) : data.invoices.map(invoice => {
                                                const customer = data.customers.find(c => c.id == invoice.customerId);
                                                return (
                                                    <tr key={invoice.id} className="border-t hover:bg-gray-50">
                                                        <td className="px-4 py-3 font-mono">{invoice.invoiceNumber}</td>
                                                        <td className="px-4 py-3">{customer?.name || 'Unknown'}</td>
                                                        <td className="px-4 py-3">{invoice.date}</td>
                                                        <td className="px-4 py-3 font-semibold">£{invoice.total.toFixed(2)}</td>
                                                        <td className="px-4 py-3">
                                                            <span className={`px-2 py-1 text-xs rounded-full ${
                                                                invoice.status === 'paid' ? 'bg-green-100 text-green-800' :
                                                                invoice.status === 'overdue' ? 'bg-red-100 text-red-800' :
                                                                'bg-yellow-100 text-yellow-800'
                                                            }`}>
                                                                {invoice.status}
                                                            </span>
                                                        </td>
                                                        <td className="px-4 py-3">
                                                            <div className="flex gap-2">
                                                                <button onClick={() => exportInvoicePDF(invoice)} className="text-purple-600 hover:text-purple-800" title="Export to PDF">
                                                                    <Icon name="Download" className="w-4 h-4" />
                                                                </button>
                                                                <button onClick={() => emailInvoice(invoice)} className="text-green-600 hover:text-green-800" title="Email Invoice">
                                                                    <Icon name="Send" className="w-4 h-4" />
                                                                </button>
                                                                <button onClick={() => openModal('invoice', invoice)} className="text-blue-600 hover:text-blue-800" title="Edit">
                                                                    <Icon name="Edit2" className="w-4 h-4" />
                                                                </button>
                                                                <button onClick={() => handleDelete('invoice', invoice.id)} className="text-red-600 hover:text-red-800" title="Delete">
                                                                    <Icon name="Trash2" className="w-4 h-4" />
                                                                </button>
                                                            </div>
                                                        </td>
                                                    </tr>
                                                );
                                            })}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        )}

                        {activeTab === 'bills' && (
                            <div className="bg-white rounded-lg shadow p-4 md:p-6">
                                <div className="flex flex-wrap justify-between items-center gap-3 mb-6">
                                    <h2 className="text-xl md:text-2xl font-bold">Purchase Bills</h2>
                                    <button onClick={() => openModal('bill')} className="flex items-center gap-2 bg-blue-600 text-white px-3 md:px-4 py-2 rounded-lg hover:bg-blue-700 text-sm md:text-base">
                                        <Icon name="Plus" className="w-4 md:w-5 h-4 md:h-5" />
                                        <span className="hidden sm:inline">Add Bill</span>
                                        <span className="sm:hidden">Add</span>
                                    </button>
                                </div>
                                <div className="overflow-x-auto">
                                    <table className="w-full min-w-[600px]">
                                        <thead className="bg-gray-50">
                                            <tr>
                                                <th className="px-2 md:px-4 py-3 text-left text-sm font-semibold">Bill #</th>
                                                <th className="px-2 md:px-4 py-3 text-left text-sm font-semibold">Supplier</th>
                                                <th className="px-2 md:px-4 py-3 text-left text-sm font-semibold hidden sm:table-cell">Date</th>
                                                <th className="px-2 md:px-4 py-3 text-left text-sm font-semibold">Total</th>
                                                <th className="px-2 md:px-4 py-3 text-left text-sm font-semibold hidden md:table-cell">Status</th>
                                                <th className="px-2 md:px-4 py-3 text-left text-sm font-semibold">Images</th>
                                                <th className="px-2 md:px-4 py-3 text-left text-sm font-semibold">Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {data.bills.length === 0 ? (
                                                <tr><td colSpan="7" className="text-center py-8 text-gray-500">No bills yet. Add your first bill!</td></tr>
                                            ) : data.bills.map(bill => {
                                                const supplier = data.suppliers.find(s => s.id == bill.supplierId);
                                                return (
                                                    <tr key={bill.id} className="border-t hover:bg-gray-50">
                                                        <td className="px-2 md:px-4 py-3 font-mono text-sm">{bill.billNumber}</td>
                                                        <td className="px-2 md:px-4 py-3 text-sm">{supplier?.name || 'Unknown'}</td>
                                                        <td className="px-2 md:px-4 py-3 text-sm hidden sm:table-cell">{bill.date}</td>
                                                        <td className="px-2 md:px-4 py-3 font-semibold text-sm">£{bill.total.toFixed(2)}</td>
                                                        <td className="px-2 md:px-4 py-3 hidden md:table-cell">
                                                            <span className={`px-2 py-1 text-xs rounded-full ${
                                                                bill.status === 'paid' ? 'bg-green-100 text-green-800' :
                                                                bill.status === 'overdue' ? 'bg-red-100 text-red-800' :
                                                                'bg-yellow-100 text-yellow-800'
                                                            }`}>
                                                                {bill.status}
                                                            </span>
                                                        </td>
                                                        <td className="px-2 md:px-4 py-3">
                                                            {bill.images && bill.images.length > 0 ? (
                                                                <div className="flex gap-1">
                                                                    <Icon name="Image" className="w-4 h-4 text-blue-600" />
                                                                    <span className="text-xs text-gray-600">{bill.images.length}</span>
                                                                </div>
                                                            ) : (
                                                                <span className="text-xs text-gray-400">-</span>
                                                            )}
                                                        </td>
                                                        <td className="px-2 md:px-4 py-3">
                                                            <div className="flex gap-2">
                                                                <button onClick={() => openModal('bill', bill)} className="text-blue-600 hover:text-blue-800">
                                                                    <Icon name="Edit2" className="w-4 h-4" />
                                                                </button>
                                                                <button onClick={() => handleDelete('bill', bill.id)} className="text-red-600 hover:text-red-800">
                                                                    <Icon name="Trash2" className="w-4 h-4" />
                                                                </button>
                                                            </div>
                                                        </td>
                                                    </tr>
                                                );
                                            })}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        )}

                        {activeTab === 'expenses' && (
                            <div className="bg-white rounded-lg shadow p-4 md:p-6">
                                <div className="flex flex-wrap justify-between items-center gap-3 mb-6">
                                    <h2 className="text-xl md:text-2xl font-bold">Expenses</h2>
                                    <button onClick={() => openModal('expense')} className="flex items-center gap-2 bg-blue-600 text-white px-3 md:px-4 py-2 rounded-lg hover:bg-blue-700 text-sm md:text-base">
                                        <Icon name="Plus" className="w-4 md:w-5 h-4 md:h-5" />
                                        <span className="hidden sm:inline">Add Expense</span>
                                        <span className="sm:hidden">Add</span>
                                    </button>
                                </div>
                                <div className="overflow-x-auto">
                                    <table className="w-full min-w-[600px]">
                                        <thead className="bg-gray-50">
                                            <tr>
                                                <th className="px-2 md:px-4 py-3 text-left text-sm font-semibold">Date</th>
                                                <th className="px-2 md:px-4 py-3 text-left text-sm font-semibold">Category</th>
                                                <th className="px-2 md:px-4 py-3 text-left text-sm font-semibold hidden md:table-cell">Description</th>
                                                <th className="px-2 md:px-4 py-3 text-left text-sm font-semibold">Amount</th>
                                                <th className="px-2 md:px-4 py-3 text-left text-sm font-semibold">Images</th>
                                                <th className="px-2 md:px-4 py-3 text-left text-sm font-semibold">Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {data.expenses.length === 0 ? (
                                                <tr><td colSpan="6" className="text-center py-8 text-gray-500">No expenses yet. Add your first expense!</td></tr>
                                            ) : data.expenses.map(expense => (
                                                <tr key={expense.id} className="border-t hover:bg-gray-50">
                                                    <td className="px-2 md:px-4 py-3 text-sm">{expense.date}</td>
                                                    <td className="px-2 md:px-4 py-3 capitalize text-sm">{expense.category}</td>
                                                    <td className="px-2 md:px-4 py-3 text-sm hidden md:table-cell">{expense.description}</td>
                                                    <td className="px-2 md:px-4 py-3 font-semibold text-sm">£{expense.amount.toFixed(2)}</td>
                                                    <td className="px-2 md:px-4 py-3">
                                                        {expense.images && expense.images.length > 0 ? (
                                                            <div className="flex gap-1">
                                                                <Icon name="Image" className="w-4 h-4 text-blue-600" />
                                                                <span className="text-xs text-gray-600">{expense.images.length}</span>
                                                            </div>
                                                        ) : (
                                                            <span className="text-xs text-gray-400">-</span>
                                                        )}
                                                    </td>
                                                    <td className="px-2 md:px-4 py-3">
                                                        <div className="flex gap-2">
                                                            <button onClick={() => openModal('expense', expense)} className="text-blue-600 hover:text-blue-800">
                                                                <Icon name="Edit2" className="w-4 h-4" />
                                                            </button>
                                                            <button onClick={() => handleDelete('expense', expense.id)} className="text-red-600 hover:text-red-800">
                                                                <Icon name="Trash2" className="w-4 h-4" />
                                                            </button>
                                                        </div>
                                                    </td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        )}

                        {activeTab === 'accounts' && (
                            <div className="bg-white rounded-lg shadow p-6">
                                <div className="flex justify-between items-center mb-6">
                                    <h2 className="text-2xl font-bold">Chart of Accounts</h2>
                                    <button onClick={() => openModal('account')} className="flex items-center gap-2 bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">
                                        <Icon name="Plus" className="w-5 h-5" />
                                        Add Account
                                    </button>
                                </div>
                                <div className="overflow-x-auto">
                                    <table className="w-full">
                                        <thead className="bg-gray-50">
                                            <tr>
                                                <th className="px-4 py-3 text-left text-sm font-semibold">Code</th>
                                                <th className="px-4 py-3 text-left text-sm font-semibold">Name</th>
                                                <th className="px-4 py-3 text-left text-sm font-semibold">Type</th>
                                                <th className="px-4 py-3 text-left text-sm font-semibold">Balance</th>
                                                <th className="px-4 py-3 text-left text-sm font-semibold">Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {data.chartOfAccounts.map(account => (
                                                <tr key={account.id} className="border-t hover:bg-gray-50">
                                                    <td className="px-4 py-3 font-mono">{account.code}</td>
                                                    <td className="px-4 py-3">{account.name}</td>
                                                    <td className="px-4 py-3">
                                                        <span className={`px-2 py-1 text-xs rounded-full ${
                                                            account.type === 'Asset' ? 'bg-blue-100 text-blue-800' :
                                                            account.type === 'Liability' ? 'bg-red-100 text-red-800' :
                                                            account.type === 'Equity' ? 'bg-purple-100 text-purple-800' :
                                                            account.type === 'Income' ? 'bg-green-100 text-green-800' :
                                                            'bg-orange-100 text-orange-800'
                                                        }`}>
                                                            {account.type}
                                                        </span>
                                                    </td>
                                                    <td className="px-4 py-3 font-semibold">£{account.balance.toLocaleString()}</td>
                                                    <td className="px-4 py-3">
                                                        <div className="flex gap-2">
                                                            <button onClick={() => openModal('account', account)} className="text-blue-600 hover:text-blue-800">
                                                                <Icon name="Edit2" className="w-4 h-4" />
                                                            </button>
                                                            <button onClick={() => handleDelete('account', account.id)} className="text-red-600 hover:text-red-800">
                                                                <Icon name="Trash2" className="w-4 h-4" />
                                                            </button>
                                                        </div>
                                                    </td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        )}

                        {activeTab === 'banking' && (
                            <div className="space-y-6">
                                <div className="bg-white rounded-lg shadow p-6">
                                    <div className="flex justify-between items-center mb-6">
                                        <h2 className="text-2xl font-bold">Bank Accounts</h2>
                                        <button onClick={() => openModal('bankAccount')} className="flex items-center gap-2 bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">
                                            <Icon name="Plus" className="w-5 h-5" />
                                            Add Bank Account
                                        </button>
                                    </div>
                                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                        {data.bankAccounts.length === 0 ? (
                                            <div className="col-span-full text-center py-8 text-gray-500">No bank accounts yet. Add your first account!</div>
                                        ) : data.bankAccounts.map(account => (
                                            <div key={account.id} className="bg-gradient-to-br from-blue-50 to-blue-100 border border-blue-200 rounded-lg p-4">
                                                <div className="flex justify-between items-start mb-3">
                                                    <h3 className="font-bold text-lg">{account.name}</h3>
                                                    <div className="flex gap-1">
                                                        <button onClick={() => openModal('bankAccount', account)} className="text-blue-600 hover:text-blue-800">
                                                            <Icon name="Edit2" className="w-4 h-4" />
                                                        </button>
                                                        <button onClick={() => handleDelete('bankAccount', account.id)} className="text-red-600 hover:text-red-800">
                                                            <Icon name="Trash2" className="w-4 h-4" />
                                                        </button>
                                                    </div>
                                                </div>
                                                <p className="text-sm text-gray-600">{account.bank}</p>
                                                {account.accountNumber && <p className="text-xs text-gray-500 font-mono">ACC: {account.accountNumber}</p>}
                                                {account.sortCode && <p className="text-xs text-gray-500 font-mono">Sort: {account.sortCode}</p>}
                                                <div className="mt-3 pt-3 border-t border-blue-200">
                                                    <p className="text-2xl font-bold text-blue-700">{account.currency} {account.balance.toLocaleString()}</p>
                                                    <p className="text-xs text-gray-600">Current Balance</p>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                </div>

                                <div className="bg-white rounded-lg shadow p-6">
                                    <div className="flex justify-between items-center mb-6">
                                        <h2 className="text-2xl font-bold">Import Transactions</h2>
                                        <label className="flex items-center gap-2 bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 cursor-pointer">
                                            <Icon name="Upload" className="w-5 h-5" />
                                            Import CSV from Tide
                                            <input type="file" accept=".csv" onChange={importBankCSV} className="hidden" />
                                        </label>
                                    </div>
                                    <div className="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4">
                                        <p className="text-sm text-gray-700"><strong>Note:</strong> For Tide bank integration, export your transactions as CSV from Tide's web portal. The CSV should have columns: Date, Description, Amount, Balance</p>
                                        <p className="text-sm text-gray-600 mt-2">Future versions may include direct API integration with Tide.</p>
                                    </div>
                                    <div className="overflow-x-auto">
                                        <table className="w-full">
                                            <thead className="bg-gray-50">
                                                <tr>
                                                    <th className="px-4 py-3 text-left text-sm font-semibold">Date</th>
                                                    <th className="px-4 py-3 text-left text-sm font-semibold">Description</th>
                                                    <th className="px-4 py-3 text-left text-sm font-semibold">Amount</th>
                                                    <th className="px-4 py-3 text-left text-sm font-semibold">Balance</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {data.bankTransactions?.length === 0 || !data.bankTransactions ? (
                                                    <tr><td colSpan="4" className="text-center py-8 text-gray-500">No transactions imported yet.</td></tr>
                                                ) : data.bankTransactions.map(txn => (
                                                    <tr key={txn.id} className="border-t hover:bg-gray-50">
                                                        <td className="px-4 py-3">{txn.date}</td>
                                                        <td className="px-4 py-3">{txn.description}</td>
                                                        <td className={`px-4 py-3 font-semibold ${txn.amount >= 0 ? 'text-green-600' : 'text-red-600'}`}>
                                                            £{txn.amount.toFixed(2)}
                                                        </td>
                                                        <td className="px-4 py-3 font-semibold">£{txn.balance.toFixed(2)}</td>
                                                    </tr>
                                                ))}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        )}

                        {activeTab === 'vat' && (
                            <div className="bg-white rounded-lg shadow p-6">
                                <div className="flex justify-between items-center mb-6">
                                    <h2 className="text-2xl font-bold">VAT Returns</h2>
                                    <button onClick={generateVATReturn} className="flex items-center gap-2 bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700">
                                        <Icon name="FileCheck" className="w-5 h-5" />
                                        Generate VAT Return
                                    </button>
                                </div>
                                <div className="overflow-x-auto">
                                    <table className="w-full">
                                        <thead className="bg-gray-50">
                                            <tr>
                                                <th className="px-4 py-3 text-left text-sm font-semibold">Period</th>
                                                <th className="px-4 py-3 text-left text-sm font-semibold">Output VAT</th>
                                                <th className="px-4 py-3 text-left text-sm font-semibold">Input VAT</th>
                                                <th className="px-4 py-3 text-left text-sm font-semibold">VAT Due</th>
                                                <th className="px-4 py-3 text-left text-sm font-semibold">Generated</th>
                                                <th className="px-4 py-3 text-left text-sm font-semibold">Status</th>
                                                <th className="px-4 py-3 text-left text-sm font-semibold">Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {data.vatReturns.length === 0 ? (
                                                <tr><td colSpan="7" className="text-center py-8 text-gray-500">No VAT returns yet. Generate your first return!</td></tr>
                                            ) : data.vatReturns.map(vat => (
                                                <tr key={vat.id} className="border-t hover:bg-gray-50">
                                                    <td className="px-4 py-3">{vat.periodStart} to {vat.periodEnd}</td>
                                                    <td className="px-4 py-3 font-semibold text-green-600">£{vat.outputVAT.toFixed(2)}</td>
                                                    <td className="px-4 py-3 font-semibold text-red-600">£{vat.inputVAT.toFixed(2)}</td>
                                                    <td className="px-4 py-3 font-bold">£{vat.vatDue.toFixed(2)}</td>
                                                    <td className="px-4 py-3">{vat.generatedDate}</td>
                                                    <td className="px-4 py-3">
                                                        <span className={`px-2 py-1 text-xs rounded-full ${
                                                            vat.status === 'filed' ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'
                                                        }`}>
                                                            {vat.status}
                                                        </span>
                                                    </td>
                                                    <td className="px-4 py-3">
                                                        <div className="flex gap-2">
                                                            {vat.status === 'draft' && (
                                                                <button onClick={() => fileVATReturn(vat.id)} className="text-green-600 hover:text-green-800 text-sm font-semibold">
                                                                    File Return
                                                                </button>
                                                            )}
                                                            <button onClick={() => handleDelete('vat', vat.id)} className="text-red-600 hover:text-red-800">
                                                                <Icon name="Trash2" className="w-4 h-4" />
                                                            </button>
                                                        </div>
                                                    </td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        )}

                        {renderModal()}
                        </div>
                        </div>
                    </div>
                </div>
            );
        };

        ReactDOM.render(<SwenlinkAccounting />, document.getElementById('root'));
    </script>
</body>
</html>
